
#-------------------------------------------------------------------------------------------
2017-10-09:|
-------------

First: Clean up ConstraintSet.scala
Clean up the tests to conform to the new signatures.

Modify FeasibilityReport to include ||Ax-b|| in case of equality constraints.

Write tests cases based on Kullback-Leibler distane minimization with known solution
(because of symmetry) or known infeasibility (because of probabilistic inequalities).



#-------------------------------------------------------------------------------------------
2017-10-10:|
-------------

Do we have to do something special if the set of inequality constraints is empty?

Add on expectation, moment and probability inequality constraints to the
Constraints object.



#----------------------------------------------------------------------------------------
2017-10-11:|
-------------

Implement feasible dist_KL problems with known analytic solutions
and some which are known to be infeasible.


#----------------------------------------------------------------------------------------
2017-10-12:|
-------------

ConstraintSet.phase_I_Analysis:

(A) The phase I problem can lead to a singular KKT system under reasonable conditions.
To see this consider a case where the side conditions are linear (hence Hessian zero)
and do not depend on some of the variables.
The Hessian of the barrier function (cvx.pdf, p40 (44)) then has zero rows.

Currently this leads to an exception in
    MatrixUtils$.ruizEquilibrate(MatrixUtils.scala:152)
	at MatrixUtils$.solveWithPreconditioning(MatrixUtils.scala:190)

as the preconditioner does not tolerate a zero row in the Hessian H
(if there are no equality conditions).

If there are no equality conditions then a zero row in the Hessian H
leads to a singular system which has zeros on the right hand side, so that it
is still solvable, but we have not implemented a solution for such a system.

The code in MatrixUtils$.solveWithPreconditioning needs to be adapted to cope
with this case also.

The problem occurs for example with the test problem
OptimizationProblems.kl_1 if we remove the probability conditions
x_j>0 and sum_jx_j=1 from the list of conditions.

(B) The barrier solver for the phase I problem does not deal with the
equality constraints correctly:
   dimension mismatch, e.g. in OptimizationProblems.kl_1
What should we do with these?
We could disregard them in phase I and return a feasible point satisfying
only the inequality constraints, then hope that a full Newton step
is taken in the solution of the original KKT system (which implies that the
equality constraints are satisfied automatically).


#----------------------------------------------------------------------------------------
2017-10-16:|
-------------

__EqualityConstraint:

implement the function ::phase_I_SOI_EqualityConstraint: EqualityConstraint

__OptimizationProblems.kl_1:
work out the solution for general n, heuristic is that the probability condition
on the big set (j>=n/2) must be hit with equality.


#----------------------------------------------------------------------------------------
2017-10-17:|
-------------

__EqualityConstraint:
implement the function ::phase_I_SOI_EqualityConstraint: EqualityConstraint

Implement bigger, randomly generated KL_problems to see how fast/slow we are
with the KKT system solution without native libraries.

!!__OptimizationProblems.kl_2
Figure out why this leads to a singular KKT system in the phase I analysis.
The hessian H of the barrier function in KKTSystem::blockSolve really is singular!
See also Log.txt.

Note: this system has only the positivity constraints x_j>0 as inequalities.
In phase I analysis the j-th constraint each of depends on the j-th variable
and the new variable s (the last variable) only. Thus the hessian of the constraint
is nonzero only on the diagonal and the last row and column.

The objective function only depends on the variable s, so the hessian has only
one nonzero entry (last diagonal element). Consequently the hessian of the barrier
function has the same structure as that of the constraints. This is indeed what we
see in the log file BUT this matrix is singular
(subtract all other rows from the last one).

It is hard to believe that the constraints x_j>0 lead to a singular hessian
for the barrier function. BUG suspected.


#----------------------------------------------------------------------------------------
2017-10-18:|
-------------

Figure out why the phase I analysis for the OptimizationProblems.kl_1
and OptimizationProblems.kl_3 run into a singular KKT system.

__BUG___ detected: Ruiz equilibration leads from a positive definite matrix H
to one which has a slightly negative eigenvalue!!!!
Then the corresponding KKTSystem is flagged as singular, see
Logs/ConstraintSet_phase_I_log.txt


#----------------------------------------------------------------------------------------
2017-11-01:|
-------------

KKTSystem.solve:
tries the block elimination with Cholesky factorization. If this fails
regularizes the system with the trick in Boyd. This will fail if the system is
singular. In this case we go to SVD. Check that all this is proper, i.e. no
regularization which distorts the system too much so solutions are no longer
Newton steps in a _descent direction_.
This could happen if we were to use simple regularization by adding eps*I
to the singular (but positive semidefinite) Hessian H.

Is likely correct.

_tolerances_:

Currently we have only one tolerance parameter to handle all tolerances:
for constraints
for the duality gap (termination criterion in barrier solver)
for norm of gradient (as termination criterion in case of interior point solution).

It may be useful to distinguish between these tolerance since in particular the
tolerance for the duality gap often has to be reduced to avoid running into a
singular KKT system.


----------------------------------------------------------------------------------------
2017-11-02:|
-------------

SOI analysis does not work (IndexOutOfBounds on DenseVector).
Run the feasibility tests in Runner.


#----------------------------------------------------------------------------------------
2017-11-21:|
-------------

KKTSystem: all solvers: added tolerance to parameters.
MatrixUtils:  added logger, debuglevel to svdSolve.

Status: new parameter signatures are only consistent within MatrixUtils and
KKTSystem. Needs to be fixed elsewhere, do a compile and look at the errors.


#----------------------------------------------------------------------------------------
2017-11-22:|
-------------

Problem dist_KL_2 fails to observe the constraint sum(x_j)=1
Computation fails due to very bad condition numbers.

This problem does have _inequality constraints_ for the probabilities
(x_j>0) so is not dissimilar to problem kl_1 with no equality constraints.

In our problem in the very first step of the Iteration along the central path
at the very first index t=1 the matrix H is easily seen to be singular!
Why is that?

Solved: by transforming the system via H -> H+A'A and the rest accordingly.


#----------------------------------------------------------------------------------------
2017-11-28:|
-------------

Status: all tests of minimization problems go through correctly except
the random power problems. Examine what's the matter with these.

Use the new random constraints in Constraints and random quadratic objective functions to

(A) build ConstraintSets with known feasible point x0 and do a phase_I_Analysis on these.
(B) Combine the Constraint sets with a quadratic objective function with global minimum
    at x=x0, then solve the constrained problem.


Might be a good idea to add a function randomConstraintSet to the object ConstraintSets.


#----------------------------------------------------------------------------------------
2017-11-29:|
-------------

Phase_I_Analysis_SOI fails on
FeasibilityTest.checkRandomFeasibleConstraints
in the case where we have too many additional equalities.
Currently we have 3 additional equalities and 20 variables.
This goes through.

Write some tests of random quadratic objective functions under random
ConstraintSets. Then import the test case from JOptimizer.


#----------------------------------------------------------------------------------------
2017-11-30:|
-------------

Write some tests based on sum of absolute values constraints,
e.g. maximize  a dot x subject to |x_j|<=|a_j|.
Might want to introduce a new method in Constraints to generate
the list of these constraints.


#----------------------------------------------------------------------------------------
2017-12-11:|
-------------

Add the new problems
OptimizationProblems.maxDotproduct,maxEigenVector
to the list in MinimizationTests.runAll.


#----------------------------------------------------------------------------------------
2017-12-12:|
-------------

cvx-notes: add references:
https://web.stanford.edu/~boyd/papers/graph_dcp.html
http://cvxr.com/dcp/

cvx-code: update all references to cvx-notes in the scala-doc.


#----------------------------------------------------------------------------------------
2017-12-13:|
-------------

Now that the natives load and we point to the openblas we have the
numerical problem with symmetry of Q*Q.t again.
Write a test to verify that the problem exists.


#----------------------------------------------------------------------------------------
2017-12-14:|
-------------

Write a function that constructs a list of constraints corresponding to
a matrix inequality Gx<=h.

SimpleOptimizationProblems.normSquaredWithFreeVariables and
SimpleOptimizationProblems.joptP2
fail in phase I analysis.


#----------------------------------------------------------------------------------------
2017-12-20:|
-------------

The phase I analysis problem is not generally bounded below.
E.g.: the SimpleOptimizationProblems.normSquaredWithFreeVariables
Thus the phase I barrier solver needs to break off as soon as the
objective s has been pushed below zero.

For this it needs to know that it is a phase I barrier solver.
We need to introduce a field into Barrier Solver which as this information.

The same applies to the phase I SOI solver.
Deal with this as follows:
the function Solver.solve gets a new parameter
  terminationCriterion: OptimizationState => Boolean

The Double parameters of this function monitor the state of the computation
(e.g.: current value of the objective function, duality gap, norm of gradient, etc)
and break off the computation based on these.

We need different termination criteria for different applications.
For example a simple phase I analysis problem needs to break off as soon as the
objective function is pushed below zero since then we have a strictly feasible
point already.

On the other hand when solving a usual minimization problem, we break off
when the duality gap or the norm of the gradient is small enough.


#----------------------------------------------------------------------------------------
2017-12-21A:|
-------------

SimpleOptimizationProblems.normSquaredWithFreeVariables
does find a feasible point but then prints nothing in the subsequent optimization.
Currently run a an adHoc problem in Runner.


#----------------------------------------------------------------------------------------
2017-12-22:|
--------------

Status:
problem f(x)=a'x subject to |x_j|<=|a_j|
phase I analysis fails, claims problem infeasible within tolerance.
Same for  problem Min f(x)=||x||_p subject to ||x||_1=1
and probably many others.
Seems like we are breaking off the phase I analysis too early (as soon as objective function
below zero)


#----------------------------------------------------------------------------------------
2017-12-27:|
-------------

The BarrierSolver needs to start from a _strictly_ feasible point since we use
the logarithmic barrier function.
This needs to be worked into the FeasibilityReport (report on strict feasibility).

SimpleOptimizationProblems.jop2 and
SimpleOptimizationProblems.normSquaredWithFreeVariables
do not run to completion.

SimpleOptimizationProblems.joptP2:
fails in phase I analysis
the equalityGap is not shrinking in the outer loop
of the barrier solver so this outer loop iterates to values of t for which the system is
too ill conditioned to be solved.
The solution of the KKTsystem does not yield a descent direction even when this system is
still well conditioned. The inner newton loop then breaks of and the outer loop moves to
the next parameter value t and the system becomes more and more ill conditioned until
the solution fails completely.


SimpleOptimizationProblems.normSquaredWithFreeVariables
fails in large dimension:
works in dimension 24 but fails in dimensions >= 25 in phase I analysis.
Note (debug in dim=2): in phase I analysis we get a singular KKT system
with zero rows and cols (why are these not eliminated?) of the form

x1-x3 = 1
0x1+0x3 = 0
-x1+x3 = 0

which is indeed unsolvable to any tolerance < 1.


#----------------------------------------------------------------------------------------
2017-12-28:|
-------------

Phase I analysis with equality constraints:
the first step minimizing ||Ax-b||? subject to the inequality constraints
breaks off too soon with completely ridiculous results making the norm huge instead of
small in the case where the constraintSet is the probability simplex.

Incidentally this problem is ill conditioned, the matrix A has rank one (only one equality)
and A'A is the matrix with all entries equal to one.

The problem then becomes the following:

Minimize (x1+x2+...+xn - 1)? subject to xj>=0.

Clearly the set of minimizers is the entire probability simplex.
In this simple problem we can study the effects of ill conditioning and regularization.


KKTSystem:
we should implement a check if the iterative solution of the linearized KKTSystem
solves the original nonlinear KKTSystem accurately and throw an exception if it does not.


KKTSystem:
we should implement a check if the iterative solution of the linearized KKTSystem
solves the original nonlinear KKTSystem accurately and throw an exception if it does not.

openblas:
we still have the problem that A.t*A is not symmetric enough to pass the LAPACK test for
symmetry. This is a problem with the prepackaged openblas.
openblas needs to be compiled from source on this machine.


#----------------------------------------------------------------------------------------
2017-12-29:|
-------------

:_ConstraintSet_:
Phase I analysis is not correct as implemented, since the termination criterion in case
there are no equality constraints does not fit if we run into this case from a phase I
analysis with equalities.

Therefore these two cases must be separated cleanly in phase I analysis.
There is no reason to move from one case to the other since both minimizations
will produce strictly feasible points.
Note that phase I analysis with equalities Ax=b minimizes ||Ax-b||^^2 subject to the
inequalities and thus conducts a phase I analysis on these inequalities without
equalities producing a strictly feasible point for these, if one exists.

Done!


#----------------------------------------------------------------------------------------
2018-01-08:|
-------------

Add a method to linearly distort a problem (linear change of coordinates).
We can then experiment with ill conditioned distortion matrices.
Method should live in Optimization problem.

Done with affine transform!


#----------------------------------------------------------------------------------------
2018-01-09:|
-------------

Throw an exception if the ConstraintSet.phase_I_Analysis with equalities is not able
to push the relative error ||Ax-b||/||b|| below pars.toleqSolve.

In OptimizationProblems implement a static method to apply an affine transform to a list
of problems and rewrite known solutions into the new variable. We can then efficiently
test affine transforms and the effect of ill conditioning on all our test problems.

SimpleOptimizationProblems.distanceFromOrigin1
does not reach the required accuracy in the value of the optimum (suboptimality greater than the duality gap).
Do we need to check the accuracy of the solution of the linearized KKT equations in the original,
nonlinear KKT equations (would have to be done in KKTSystem)?